# Metric Registry for MinIVess MLOps
# ---------------------------------------------------------------------------
# Defines all tracked metrics with display names, optimization directions,
# value bounds, and MLflow key templates.
#
# Fields per entry
# ----------------
# name         : Internal snake_case identifier (referenced throughout code).
# display_name : Human-readable label for plots and reports.
# mlflow_name  : MLflow metric name template; use {fold_id} for per-fold
#                eval metrics (e.g. "eval_fold{fold_id}_dsc").
# direction    : "maximize" or "minimize" — which direction is better.
# unit         : Unit string for axis labels ("mm", "%", or "" for unitless).
# bounds       : [lower, upper] valid range used for sanity checks.
# description  : Brief plain-text description of the metric.
# ---------------------------------------------------------------------------

metrics:

  # --------------------------------------------------------------------------
  # Voxel-overlap metrics (per-fold evaluation)
  # --------------------------------------------------------------------------

  - name: dsc
    display_name: "Dice Score (DSC)"
    mlflow_name: "eval_fold{fold_id}_dsc"
    direction: maximize
    unit: ""
    bounds: [0.0, 1.0]
    description: >
      Voxel-level overlap between predicted and ground-truth segmentation
      masks.  Higher is better; 1.0 = perfect overlap.

  - name: centreline_dsc
    display_name: "Centreline DSC (clDice)"
    mlflow_name: "eval_fold{fold_id}_centreline_dsc"
    direction: maximize
    unit: ""
    bounds: [0.0, 1.0]
    description: >
      Skeleton-based topology preservation metric.  Measures overlap of
      vessel centrelines rather than voxel masks.  Preferred metric for
      tubular structure segmentation.

  # --------------------------------------------------------------------------
  # Surface distance metrics (per-fold evaluation)
  # --------------------------------------------------------------------------

  - name: measured_masd
    display_name: "Mean Avg. Surface Distance (MASD)"
    mlflow_name: "eval_fold{fold_id}_measured_masd"
    direction: minimize
    unit: "voxels"
    bounds: [0.0, 50.0]
    description: >
      Average symmetric surface distance between predicted and ground-truth
      boundaries, measured in voxels.  Lower is better; 0.0 = perfect
      boundary alignment.

  # --------------------------------------------------------------------------
  # Compound / primary metric (per-epoch validation)
  # --------------------------------------------------------------------------

  - name: val_compound_masd_cldice
    display_name: "Compound MASD+clDice"
    mlflow_name: "val_compound_masd_cldice"
    direction: maximize
    unit: ""
    bounds: [0.0, 1.0]
    description: >
      Primary training metric: 0.5 * (1 - normalised_MASD) + 0.5 * clDice.
      Combines surface accuracy and topology preservation into a single
      score that is logged every validation epoch.

  # --------------------------------------------------------------------------
  # Per-epoch validation metrics
  # --------------------------------------------------------------------------

  - name: val_loss
    display_name: "Validation Loss"
    mlflow_name: "val_loss"
    direction: minimize
    unit: ""
    bounds: [0.0, 10.0]
    description: >
      Total validation loss value computed at each validation epoch using
      the same loss function as training.

  - name: val_dice
    display_name: "Validation Dice"
    mlflow_name: "val_dice"
    direction: maximize
    unit: ""
    bounds: [0.0, 1.0]
    description: >
      Dice score computed on the validation split at each validation epoch.
      Tracked alongside the compound primary metric.

  - name: val_cldice
    display_name: "Validation clDice"
    mlflow_name: "val_cldice"
    direction: maximize
    unit: ""
    bounds: [0.0, 1.0]
    description: >
      Centreline Dice score on the validation split, logged every five epochs
      (skeleton computation is ~4 min for 24 full volumes).

  - name: val_masd
    display_name: "Validation MASD"
    mlflow_name: "val_masd"
    direction: minimize
    unit: "voxels"
    bounds: [0.0, 50.0]
    description: >
      Mean Average Surface Distance on the validation split, logged every
      five epochs alongside clDice.

  - name: val_f1_foreground
    display_name: "Validation F1 (foreground)"
    mlflow_name: "val_f1_foreground"
    direction: maximize
    unit: ""
    bounds: [0.0, 1.0]
    description: >
      F1 score computed on the foreground (vessel) class of the validation
      split, logged every validation epoch.

  # --------------------------------------------------------------------------
  # Topology metrics (computed every N epochs — expensive)
  # --------------------------------------------------------------------------

  - name: nsd
    display_name: "Normalized Surface Dice (NSD)"
    mlflow_name: "eval_fold{fold_id}_nsd"
    direction: maximize
    unit: ""
    bounds: [0.0, 1.0]
    description: >
      Fraction of predicted boundary within tolerance tau of the ground truth
      boundary. Default tau = 1.0 voxels (~2 * median_voxel_spacing for MiniVess).

  - name: hd95
    display_name: "Hausdorff Distance 95th percentile"
    mlflow_name: "eval_fold{fold_id}_hd95"
    direction: minimize
    unit: "voxels"
    bounds: [0.0, 100.0]
    description: >
      95th percentile of symmetric Hausdorff distance. Robust to single-voxel
      outliers while capturing worst-case boundary error.

  - name: ccdice
    display_name: "Connected-Component Dice (ccDice)"
    mlflow_name: "eval_fold{fold_id}_ccdice"
    direction: maximize
    unit: ""
    bounds: [0.0, 1.0]
    description: >
      Fragmentation-aware Dice that decomposes masks into connected components,
      matches via Hungarian algorithm, then averages per-component Dice.

  - name: betti_error_beta0
    display_name: "Betti-0 Error (component count)"
    mlflow_name: "eval_fold{fold_id}_betti_error_beta0"
    direction: minimize
    unit: ""
    bounds: [0.0, 100.0]
    description: >
      Absolute difference in connected component counts between predicted
      and ground truth masks. |cc_count(pred) - cc_count(gt)|.

  - name: junction_f1
    display_name: "Junction F1 Score"
    mlflow_name: "eval_fold{fold_id}_junction_f1"
    direction: maximize
    unit: ""
    bounds: [0.0, 1.0]
    description: >
      Bifurcation detection accuracy measured by matching junctions from
      predicted and ground truth centreline graphs within distance tolerance.

  - name: val_compound_nsd_cldice
    display_name: "Compound NSD+clDice"
    mlflow_name: "val_compound_nsd_cldice"
    direction: maximize
    unit: ""
    bounds: [0.0, 1.0]
    description: >
      Improved compound metric replacing MASD+clDice: 0.5 * NSD + 0.5 * clDice.
      Both components are in [0, 1] with consistent scale, avoiding range collapse.

  # --------------------------------------------------------------------------
  # Graph-based metrics (from vessel graph extraction — Issue #124)
  # --------------------------------------------------------------------------

  - name: apls
    display_name: "Average Path Length Similarity (APLS)"
    mlflow_name: "eval_fold{fold_id}_apls"
    direction: maximize
    unit: ""
    bounds: [0.0, 1.0]
    description: >
      Graph-based connectivity metric comparing shortest-path lengths between
      matched endpoint pairs in predicted and ground truth vessel graphs.
      Uses Hungarian matching on endpoints + spatial penalty for distant matches.

  - name: skeleton_recall_metric
    display_name: "Skeleton Recall"
    mlflow_name: "eval_fold{fold_id}_skeleton_recall"
    direction: maximize
    unit: ""
    bounds: [0.0, 1.0]
    description: >
      Fraction of ground truth skeleton voxels covered by the prediction mask
      within a distance tolerance. Measures how well the prediction preserves
      the true centreline structure.

  - name: bdr
    display_name: "Branch Detection Rate (BDR)"
    mlflow_name: "eval_fold{fold_id}_bdr"
    direction: maximize
    unit: ""
    bounds: [0.0, 1.0]
    description: >
      Fraction of ground truth vessel branches that are matched by predicted
      branches, based on endpoint proximity and length similarity thresholds.
      Uses Hungarian matching on branch pairs.

  # --------------------------------------------------------------------------
  # Murray's law compliance (P2 — Issue #131, EXPERIMENTAL)
  # --------------------------------------------------------------------------

  - name: murray_compliance
    display_name: "Murray's Law Compliance"
    mlflow_name: "eval_fold{fold_id}_murray_compliance"
    direction: maximize
    unit: ""
    bounds: [0.0, 1.0]
    description: >
      EXPERIMENTAL: Measures how well vessel bifurcations follow Murray's cubic
      branching law (r_parent^3 = sum r_daughter_i^3). Uses centreline graph
      radii estimated from distance transform. Score 1.0 = perfect compliance.
